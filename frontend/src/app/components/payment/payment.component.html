<div class="payment-container">
  <!-- Premium Compact Header -->
  <div class="compact-header">
    <div class="header-left">
      <div class="icon-circle-small">
        <mat-icon>payments</mat-icon>
      </div>
      <h1 class="page-title-compact">Payments</h1>
    </div>
    <div class="header-right">
      <!-- Company Filter -->
      <mat-form-field class="company-field-compact" appearance="outline">
        <mat-icon matPrefix>business</mat-icon>
        <mat-select placeholder="All Companies" [value]="selectedCompanyId()"
          (selectionChange)="onCompanyFilterChange($event.value)">
          <mat-option [value]="null">All Companies</mat-option>
          @for (company of companies(); track company.id) {
          <mat-option [value]="company.id">{{ company.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Add Button -->
      @if (authService.hasPermission('add_payment')) {
      <button mat-raised-button class="add-btn-compact" (click)="showAddForm()">
        <mat-icon>add</mat-icon>
        Add Payment
      </button>
      }
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
  <div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="loading-text">Loading payments...</p>
  </div>
  }

  <!-- Empty State -->
  @else if (payments().length === 0) {
  <mat-card class="empty-state-card">
    <div class="empty-state-content">
      <div class="empty-icon-wrapper">
        <mat-icon class="empty-icon">account_balance_wallet</mat-icon>
      </div>
      <h2 class="empty-title">No Payments Found</h2>
      <p class="empty-text">
        No payments found. Click "Add Payment" to record a new transaction.
      </p>
      @if (authService.hasPermission('add_payment')) {
      <button mat-raised-button class="empty-action-btn" (click)="showAddForm()">
        <mat-icon>add</mat-icon>
        Add Payment
      </button>
      }
    </div>
  </mat-card>
  }

  <!-- Desktop Table View -->
  @else {
  <mat-card class="table-card hide-on-mobile">
    <div class="table-header">
      <div class="table-title-section">
        <mat-icon class="table-icon">list</mat-icon>
        <h2 class="table-title">Payment List</h2>
      </div>
    </div>

    <div class="table-wrapper">
      <table mat-table [dataSource]="payments()" class="data-table">
        <!-- Payment Number Column -->
        <ng-container matColumnDef="payment_number">
          <th mat-header-cell *matHeaderCellDef>Payment #</th>
          <td mat-cell *matCellDef="let payment">
            <span class="quotation-number-badge">{{ payment.payment_number }}</span>
          </td>
        </ng-container>

        <!-- Date Column -->
        <ng-container matColumnDef="payment_date">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let payment" class="date-cell">
            <div class="date-wrapper">
              <mat-icon class="mini-icon">calendar_today</mat-icon>
              {{ formatDate(payment.payment_date) }}
            </div>
          </td>
        </ng-container>

        <!-- Company Column -->
        <ng-container matColumnDef="company_name">
          <th mat-header-cell *matHeaderCellDef>Company</th>
          <td mat-cell *matCellDef="let payment">
            <span class="company-name">{{ payment.company_name || 'N/A' }}</span>
          </td>
        </ng-container>

        <!-- Amount Column -->
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Amount</th>
          <td mat-cell *matCellDef="let payment">
            <span class="amount-badge">{{ formatCurrency(payment.amount) }}</span>
          </td>
        </ng-container>

        <!-- Payment Mode Column -->
        <ng-container matColumnDef="payment_mode">
          <th mat-header-cell *matHeaderCellDef>Mode</th>
          <td mat-cell *matCellDef="let payment">
            <span class="payment-mode-badge" [class]="payment.payment_mode">
              {{ getPaymentModeLabel(payment.payment_mode) }}
            </span>
          </td>
        </ng-container>

        <!-- Description Column -->
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let payment">
            <span class="truncate-text" [matTooltip]="payment.description || ''">
              {{ payment.description || '-' }}
            </span>
          </td>
        </ng-container>

        <!-- Reference Column -->
        <ng-container matColumnDef="reference">
          <th mat-header-cell *matHeaderCellDef>Reference</th>
          <td mat-cell *matCellDef="let payment">
            <span class="reference-text">{{ payment.reference || '-' }}</span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let payment" class="actions-cell">
            @if (authService.hasPermission('change_payment')) {
            <button mat-icon-button class="action-icon-btn" (click)="showEditForm(payment)" matTooltip="Edit">
              <mat-icon>edit</mat-icon>
            </button>
            }
            @if (authService.hasPermission('delete_payment')) {
            <button mat-icon-button class="action-icon-btn delete" (click)="deletePayment(payment)" matTooltip="Delete">
              <mat-icon>delete</mat-icon>
            </button>
            }
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="payment-row"></tr>
      </table>
    </div>

    <!-- Pagination -->
    <mat-paginator [length]="totalPayments()" [pageSize]="pageSize()" [pageIndex]="pageIndex()"
      [pageSizeOptions]="[6, 12, 24, 50]" (page)="onPageChange($event)" showFirstLastButtons>
    </mat-paginator>
  </mat-card>

  <!-- Mobile Card View -->
  <div class="mobile-cards hide-on-desktop">
    @for (payment of payments(); track payment.id) {
    <div class="mobile-payment-card">
      <div class="card-header-mobile">
        <div class="header-top-row">
          <span class="quotation-number-badge">{{ payment.payment_number }}</span>
          <span class="amount-badge">{{ formatCurrency(payment.amount) }}</span>
        </div>
        <div class="date-wrapper-mobile">
          <mat-icon class="mini-icon">calendar_today</mat-icon>
          {{ formatDate(payment.payment_date) }}
        </div>
      </div>

      <div class="card-body-mobile">
        <div class="company-info-mobile">
          <span class="company-name">{{ payment.company_name || 'N/A' }}</span>
        </div>

        <div class="payment-mode-section">
          <span class="payment-mode-badge" [class]="payment.payment_mode">
            {{ getPaymentModeLabel(payment.payment_mode) }}
          </span>
        </div>

        @if (payment.description) {
        <div style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">{{ payment.description }}</div>
        }
      </div>

      <div class="card-actions-mobile">
        @if (authService.hasPermission('change_payment')) {
        <button mat-icon-button class="mobile-action-icon" (click)="showEditForm(payment)">
          <mat-icon>edit</mat-icon>
        </button>
        }
        @if (authService.hasPermission('delete_payment')) {
        <button mat-icon-button class="mobile-action-icon delete" (click)="deletePayment(payment)">
          <mat-icon>delete</mat-icon>
        </button>
        }
      </div>
    </div>
    }

    <!-- Mobile Pagination -->
    <mat-paginator [length]="totalPayments()" [pageSize]="pageSize()" [pageIndex]="pageIndex()"
      [pageSizeOptions]="[6, 12, 24]" (page)="onPageChange($event)">
    </mat-paginator>
  </div>
  }
</div>