<div class="invoice-container">
  <!-- Premium Compact Header -->
  <div class="compact-header">
    <div class="header-left">
      <div class="icon-circle-small">
        <mat-icon>receipt_long</mat-icon>
      </div>
      <h1 class="page-title-compact">Invoices</h1>
    </div>
    <div class="header-right">
      <!-- Company Filter -->
      <mat-form-field class="company-field-compact" appearance="outline">
        <mat-icon matPrefix>business</mat-icon>
        <mat-select placeholder="All Companies" [value]="selectedCompanyId()"
          (selectionChange)="onCompanyFilterChange($event.value)">
          <mat-option [value]="null">All Companies</mat-option>
          @for (company of companies(); track company.id) {
          <mat-option [value]="company.id">{{ company.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Add Button -->
      @if (authService.hasPermission('add_invoice')) {
      <button mat-raised-button class="add-btn-compact" (click)="showAddForm()">
        <mat-icon>add</mat-icon>
        Add Invoice
      </button>
      }
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
  <div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="loading-text">Loading invoices...</p>
  </div>
  }

  <!-- Empty State -->
  @else if (invoices().length === 0) {
  <mat-card class="empty-state-card">
    <div class="empty-state-content">
      <div class="empty-icon-wrapper">
        <mat-icon class="empty-icon">description</mat-icon>
      </div>
      <h2 class="empty-title">No Invoices Found</h2>
      <p class="empty-text">
        No invoices found. Click "Add Invoice" to create your first invoice.
      </p>
      @if (authService.hasPermission('add_invoice')) {
      <button mat-raised-button class="empty-action-btn" (click)="showAddForm()">
        <mat-icon>add</mat-icon>
        Create Invoice
      </button>
      }
    </div>
  </mat-card>
  }

  <!-- Desktop Table View -->
  @else {
  <mat-card class="table-card hide-on-mobile">
    <div class="table-header">
      <div class="table-title-section">
        <mat-icon class="table-icon">receipt_long</mat-icon>
        <h2 class="table-title">Invoice List</h2>
      </div>
    </div>

    <div class="table-wrapper">
      <table mat-table [dataSource]="invoices()" class="data-table">
        <!-- Invoice Number Column -->
        <ng-container matColumnDef="invoice_number">
          <th mat-header-cell *matHeaderCellDef>Invoice #</th>
          <td mat-cell *matCellDef="let invoice">
            <span class="quotation-number-badge">{{ invoice.invoice_number }}</span>
          </td>
        </ng-container>

        <!-- Date Column -->
        <ng-container matColumnDef="invoice_date">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let invoice" class="date-cell">
            <div class="date-wrapper">
              <mat-icon class="mini-icon">calendar_today</mat-icon>
              {{ formatDate(invoice.invoice_date) }}
            </div>
          </td>
        </ng-container>

        <!-- Company Column -->
        <ng-container matColumnDef="company_name">
          <th mat-header-cell *matHeaderCellDef>Company</th>
          <td mat-cell *matCellDef="let invoice">
            <span class="company-name">{{ invoice.company_name || 'N/A' }}</span>
          </td>
        </ng-container>

        <!-- Amount Column -->
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Amount</th>
          <td mat-cell *matCellDef="let invoice">
            <span class="amount-badge">{{ formatCurrency(invoice.amount) }}</span>
          </td>
        </ng-container>

        <!-- Description Column -->
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let invoice">
            <span class="truncate-text" [matTooltip]="invoice.description || ''">
              {{ invoice.description || '-' }}
            </span>
          </td>
        </ng-container>

        <!-- Reference Column -->
        <ng-container matColumnDef="reference">
          <th mat-header-cell *matHeaderCellDef>Reference</th>
          <td mat-cell *matCellDef="let invoice">
            <span class="reference-text">{{ invoice.reference || '-' }}</span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let invoice" class="actions-cell">
            @if (authService.hasPermission('change_invoice')) {
            <button mat-icon-button class="action-icon-btn" (click)="showEditForm(invoice)" matTooltip="Edit">
              <mat-icon>edit</mat-icon>
            </button>
            }
            @if (authService.hasPermission('delete_invoice')) {
            <button mat-icon-button class="action-icon-btn delete" (click)="deleteInvoice(invoice)" matTooltip="Delete">
              <mat-icon>delete</mat-icon>
            </button>
            }
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="invoice-row"></tr>
      </table>
    </div>

    <!-- Pagination -->
    <mat-paginator [length]="totalInvoices()" [pageSize]="pageSize()" [pageIndex]="pageIndex()"
      [pageSizeOptions]="[6, 12, 24, 50]" (page)="onPageChange($event)" showFirstLastButtons>
    </mat-paginator>
  </mat-card>

  <!-- Mobile Card View -->
  <div class="mobile-cards hide-on-desktop">
    @for (invoice of invoices(); track invoice.id) {
    <div class="mobile-invoice-card">
      <div class="card-header-mobile">
        <div class="header-top-row">
          <span class="quotation-number-badge">{{ invoice.invoice_number }}</span>
          <span class="amount-badge">{{ formatCurrency(invoice.amount) }}</span>
        </div>
        <div class="date-wrapper-mobile">
          <mat-icon class="mini-icon">calendar_today</mat-icon>
          {{ formatDate(invoice.invoice_date) }}
        </div>
      </div>

      <div class="card-body-mobile">
        <div class="company-info-mobile">
          <span class="company-name">{{ invoice.company_name || 'N/A' }}</span>
        </div>
        @if (invoice.description) {
        <div style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">{{ invoice.description }}</div>
        }
      </div>

      <div class="card-actions-mobile">
        @if (authService.hasPermission('change_invoice')) {
        <button mat-icon-button class="mobile-action-icon" (click)="showEditForm(invoice)">
          <mat-icon>edit</mat-icon>
        </button>
        }
        @if (authService.hasPermission('delete_invoice')) {
        <button mat-icon-button class="mobile-action-icon delete" (click)="deleteInvoice(invoice)">
          <mat-icon>delete</mat-icon>
        </button>
        }
      </div>
    </div>
    }

    <!-- Mobile Pagination -->
    <mat-paginator [length]="totalInvoices()" [pageSize]="pageSize()" [pageIndex]="pageIndex()"
      [pageSizeOptions]="[6, 12, 24]" (page)="onPageChange($event)">
    </mat-paginator>
  </div>
  }
</div>