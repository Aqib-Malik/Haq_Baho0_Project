<div class="dialog-container">
    <div class="dialog-header">
        <div class="title-wrapper">
            <div class="icon-circle">
                <mat-icon>inventory_2</mat-icon>
            </div>
            <div>
                <h2 class="dialog-title">{{ isEditMode ? 'Edit Item' : 'New Item' }}</h2>
                <p class="dialog-subtitle">{{ isEditMode ? 'Update details' : 'Add new product or service' }}</p>
            </div>
        </div>
        <button mat-icon-button class="close-btn" (click)="onCancel()" type="button">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <div class="dialog-content">
        <form [formGroup]="inventoryForm" (ngSubmit)="onSubmit()">

            <!-- Section 1: Product Basics -->
            <div class="form-section">
                <h3 class="section-title">Product Details</h3>
                <div class="form-grid">
                    <!-- Name -->
                    <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
                        <mat-label>Item Name</mat-label>
                        <input matInput formControlName="name" placeholder="e.g. Panadol 500mg" required>
                        <mat-icon matPrefix>inventory_2</mat-icon>
                        <mat-error *ngIf="inventoryForm.get('name')?.hasError('required')">Required</mat-error>
                    </mat-form-field>

                    <!-- Category -->
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Category</mat-label>
                        <input matInput formControlName="category" placeholder="e.g. Medicine"
                            [matAutocomplete]="autoCat">
                        <mat-icon matPrefix>category</mat-icon>
                        <mat-autocomplete #autoCat="matAutocomplete" class="category-panel">
                            @for (cat of categories(); track cat) {
                            <mat-option [value]="cat">{{ cat }}</mat-option>
                            }
                        </mat-autocomplete>
                    </mat-form-field>

                    <!-- SKU -->
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>SKU / Barcode (Optional)</mat-label>
                        <input matInput formControlName="sku" placeholder="Scan or type code">
                        <mat-icon matPrefix>qr_code</mat-icon>
                    </mat-form-field>

                    <!-- Description -->
                    <mat-form-field appearance="outline" class="full-width textarea-field" subscriptSizing="dynamic">
                        <mat-label>Description</mat-label>
                        <textarea matInput formControlName="description" rows="3"
                            placeholder="Product details..."></textarea>
                        <mat-icon matPrefix>description</mat-icon>
                    </mat-form-field>
                </div>
            </div>

            <!-- Section 2: Stock & Tracking -->
            <div class="form-section">
                <h3 class="section-title">Stock & Storage</h3>
                <div class="form-grid">
                    <!-- Unit (Using Base Unit FK for robustness, creates simpler UX) -->
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Measuring Unit</mat-label>
                        <mat-select formControlName="base_unit" (selectionChange)="onUnitChange($event)" required>
                            <mat-option [value]="null">-- Select Unit --</mat-option>
                            @for (unit of unitsList(); track unit.id) {
                            <mat-option [value]="unit.id">{{ unit.name }} ({{ unit.code }})</mat-option>
                            }
                        </mat-select>
                        <mat-icon matPrefix>straighten</mat-icon>
                        <mat-hint>e.g. Box, Kg, Liter</mat-hint>
                    </mat-form-field>

                    <!-- Price -->
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Standard Price</mat-label>
                        <span matPrefix class="currency-prefix">Rs&nbsp;</span>
                        <input matInput type="number" formControlName="unit_price" min="0">
                    </mat-form-field>

                    <!-- Location -->
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Storage Location</mat-label>
                        <mat-select formControlName="default_location">
                            <mat-option [value]="null">-- Default / General --</mat-option>
                            @for (loc of locationsList(); track loc.id) {
                            <mat-option [value]="loc.id">{{ loc.name }}</mat-option>
                            }
                        </mat-select>
                        <mat-icon matPrefix>place</mat-icon>
                    </mat-form-field>

                    <!-- Low Stock Alert -->
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Low Stock Alert</mat-label>
                        <input matInput type="number" formControlName="min_stock_level" min="0">
                        <mat-icon matPrefix>notifications_active</mat-icon>
                        <mat-hint>Alert when stock falls below this</mat-hint>
                    </mat-form-field>
                </div>

                <!-- Batch Tracking Checkbox -->
                <div class="tracking-option">
                    <mat-checkbox formControlName="batch_tracking" color="primary">
                        <div class="checkbox-label">
                            <span class="main-text">Track Batches & Expiry Dates</span>
                            <span class="sub-text">Recommended for medicines, food, and perishable items</span>
                        </div>
                    </mat-checkbox>
                </div>
            </div>

            <div class="dialog-actions">
                <button mat-stroked-button type="button" (click)="onCancel()">Cancel</button>
                <button mat-raised-button color="primary" type="submit" [disabled]="isLoading()">
                    <mat-icon>save</mat-icon>
                    {{ isLoading() ? 'Saving...' : 'Save Item' }}
                </button>
            </div>
        </form>
    </div>
</div>