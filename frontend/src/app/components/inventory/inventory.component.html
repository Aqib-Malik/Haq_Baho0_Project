<div class="inventory-container">
    <mat-tab-group animationDuration="0ms" [(selectedIndex)]="selectedTabIndex"
        (selectedIndexChange)="onTabChange($event)" class="inventory-tabs">
        <!-- Tab 1: Items -->
        <mat-tab label="Items">
            <div class="tab-content">
                <!-- Premium Compact Header -->
                <div class="compact-header">
                    <div class="header-left">
                        <div class="icon-circle-small">
                            <mat-icon>inventory_2</mat-icon>
                        </div>
                        <h1 class="page-title-compact">Inventory Items</h1>
                    </div>
                    <div class="header-right">
                        <!-- Search Filter -->
                        <mat-form-field class="search-field-compact" appearance="outline" subscriptSizing="dynamic">
                            <mat-icon matPrefix>search</mat-icon>
                            <input matInput [formControl]="searchControl" placeholder="Find by name...">
                            <button *ngIf="searchControl.value" matSuffix mat-icon-button
                                (click)="searchControl.setValue('')">
                                <mat-icon>close</mat-icon>
                            </button>
                        </mat-form-field>

                        <!-- Add Button -->
                        <button mat-raised-button class="add-btn-compact" (click)="openInventoryDialog()">
                            <mat-icon>add</mat-icon>
                            Add Item
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                @if (isLoading()) {
                <div class="loading-container">
                    <mat-spinner diameter="50"></mat-spinner>
                    <p class="loading-text">Loading inventory...</p>
                </div>
                }

                <!-- Empty State -->
                @else if (items().length === 0) {
                <mat-card class="empty-state-card">
                    <div class="empty-state-content">
                        <div class="empty-icon-wrapper">
                            <mat-icon class="empty-icon">inventory_2</mat-icon>
                        </div>
                        <h2 class="empty-title">No Items Found</h2>
                        <p class="empty-text">
                            Start by adding items to your inventory. Track products, services, and manage your stock
                            efficiently.
                        </p>
                        <button mat-raised-button class="empty-action-btn" (click)="openInventoryDialog()">
                            <mat-icon>add</mat-icon>
                            Add First Item
                        </button>
                    </div>
                </mat-card>
                }

                <!-- Desktop & Mobile Unified Card View -->
                @else {
                <div class="inventory-grid">
                    @for (item of items(); track item.id) {
                    <mat-card class="inventory-card">
                        <div class="card-content">
                            <!-- Header: Name & Price -->
                            <div class="card-header-row">
                                <div class="item-identity">
                                    <span class="item-name">{{ item.name }}</span>
                                    <span class="item-id">ID: #{{ item.id }}</span>
                                </div>
                                <span class="price-badge">{{ formatCurrency(item.unit_price) }}</span>
                            </div>

                            <!-- Meta Info: Category & Unit -->
                            <div class="card-meta-row">
                                <div class="meta-badges">
                                    @if (item.category) {
                                    <span class="category-badge">
                                        <mat-icon>category</mat-icon>
                                        {{ item.category }}
                                    </span>
                                    }
                                    <span class="unit-badge">
                                        <mat-icon>straighten</mat-icon>
                                        {{ item.unit }}
                                    </span>
                                    <span class="stock-badge"
                                        [class.low-stock]="((item.stock_quantity ?? 0) <= (item.min_stock_level ?? 0))">
                                        <mat-icon>inventory</mat-icon>
                                        {{ (item.stock_quantity ?? 0) | number:'1.0-4' }}
                                    </span>
                                </div>
                            </div>

                            <!-- Description Block -->
                            <div class="description-block">
                                <p class="desc-text">{{ item.description || 'No description available.' }}</p>
                            </div>

                            <!-- Actions Footer -->
                            <div class="card-actions">
                                <div class="action-buttons">
                                    <button mat-stroked-button class="edit-btn" (click)="openInventoryDialog(item)">
                                        <mat-icon>edit</mat-icon> Edit
                                    </button>
                                    <button mat-stroked-button class="delete-btn" (click)="confirmDelete(item)">
                                        <mat-icon>delete</mat-icon> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </mat-card>
                    }
                </div>

                <!-- Pagination -->
                <mat-paginator [length]="totalItems()" [pageSize]="pageSize" [pageIndex]="pageIndex"
                    [pageSizeOptions]="[10, 25, 50]" (page)="onPageChange($event)" showFirstLastButtons
                    class="custom-paginator">
                </mat-paginator>
                }
            </div>
        </mat-tab>

        <!-- Tab 2: Stock Transactions (Hidden for now) -->
        <mat-tab label="Stock Transactions" *ngIf="false">
            <div class="tab-content">
                <div class="compact-header">
                    <div class="header-left">
                        <div class="icon-circle-small blue-icon">
                            <mat-icon>receipt_long</mat-icon>
                        </div>
                        <h1 class="page-title-compact">Stock Movement</h1>
                    </div>
                    <div class="header-right">
                        <!-- Type Filter -->
                        <mat-form-field class="search-field-compact" appearance="outline" subscriptSizing="dynamic">
                            <mat-icon matPrefix>filter_list</mat-icon>
                            <mat-select [formControl]="transactionTypeControl" placeholder="All Types">
                                <mat-option value="">All Types</mat-option>
                                <mat-option value="receipt">Receipt (In)</mat-option>
                                <mat-option value="issue">Issue (Out)</mat-option>
                                <mat-option value="return">Return</mat-option>
                                <mat-option value="adjustment">Adjustment</mat-option>
                            </mat-select>
                        </mat-form-field>

                        <!-- New Transaction Button -->
                        <button mat-raised-button class="add-btn-compact" (click)="openTransactionDialog()">
                            <mat-icon>add</mat-icon>
                            New Transaction
                        </button>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="table-container">
                    <table mat-table [dataSource]="transactions()" class="custom-table">
                        <!-- Date Column -->
                        <ng-container matColumnDef="date">
                            <th mat-header-cell *matHeaderCellDef> Date </th>
                            <td mat-cell *matCellDef="let element"> {{element.transaction_date | date}} </td>
                        </ng-container>

                        <!-- Type Column -->
                        <ng-container matColumnDef="type">
                            <th mat-header-cell *matHeaderCellDef> Type </th>
                            <td mat-cell *matCellDef="let element">
                                <span class="type-badge" [ngClass]="element.transaction_type">
                                    {{element.transaction_type | titlecase}}
                                </span>
                            </td>
                        </ng-container>

                        <!-- Item Column -->
                        <ng-container matColumnDef="item">
                            <th mat-header-cell *matHeaderCellDef> Item </th>
                            <td mat-cell *matCellDef="let element">
                                <span class="item-name-cell">{{element.item_name}}</span>
                                <span class="batch-info" *ngIf="element.batch_number">Batch:
                                    {{element.batch_number}}</span>
                            </td>
                        </ng-container>

                        <!-- Quantity Column -->
                        <ng-container matColumnDef="quantity">
                            <th mat-header-cell *matHeaderCellDef> Quantity </th>
                            <td mat-cell *matCellDef="let element"
                                [class.negative-qty]="element.transaction_type === 'issue'">
                                {{element.quantity | number:'1.0-4'}} {{element.unit_name}}
                            </td>
                        </ng-container>

                        <!-- Location Column -->
                        <ng-container matColumnDef="location">
                            <th mat-header-cell *matHeaderCellDef> Location </th>
                            <td mat-cell *matCellDef="let element"> {{element.location_name || '-'}} </td>
                        </ng-container>

                        <!-- Project Column -->
                        <ng-container matColumnDef="project">
                            <th mat-header-cell *matHeaderCellDef> Project </th>
                            <td mat-cell *matCellDef="let element"> {{element.project_name || '-'}} </td>
                        </ng-container>

                        <!-- Ref Column -->
                        <ng-container matColumnDef="reference">
                            <th mat-header-cell *matHeaderCellDef> Reference </th>
                            <td mat-cell *matCellDef="let element"> {{element.reference_number || '-'}} </td>
                        </ng-container>

                        <!-- Actions Column -->
                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef style="text-align: center;"> Actions </th>
                            <td mat-cell *matCellDef="let element" class="actions-cell">
                                <button mat-icon-button class="action-icon-btn view" (click)="viewTransaction(element)"
                                    matTooltip="View Details">
                                    <mat-icon>visibility</mat-icon>
                                </button>
                                <button mat-icon-button class="action-icon-btn" (click)="editTransaction(element)"
                                    matTooltip="Edit">
                                    <mat-icon>edit</mat-icon>
                                </button>
                                <button mat-icon-button class="action-icon-btn delete"
                                    (click)="confirmDeleteTransaction(element)" matTooltip="Delete">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row
                            *matHeaderRowDef="['date', 'type', 'item', 'quantity', 'location', 'project', 'reference', 'actions']">
                        </tr>
                        <tr mat-row
                            *matRowDef="let row; columns: ['date', 'type', 'item', 'quantity', 'location', 'project', 'reference', 'actions'];">
                        </tr>

                        <!-- Empty Data -->
                        <tr class="mat-row" *matNoDataRow>
                            <td class="mat-cell" colspan="6" style="text-align: center; padding: 2rem;">
                                No transactions found
                            </td>
                        </tr>
                    </table>
                </div>

                <mat-paginator [length]="totalTransactions()" [pageSize]="transactionPageSize"
                    [pageSizeOptions]="[10, 25, 50]" (page)="onTransactionPageChange($event)" showFirstLastButtons
                    class="custom-paginator">
                </mat-paginator>
            </div>
        </mat-tab>
    </mat-tab-group>
</div>